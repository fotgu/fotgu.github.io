---
date: '2025-03-12'
draft: true
title: '不要过早优化'
description: ''
summary: '删繁就简三秋树，领异标新二月花'
tags: ["工程思维"]
---

> We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil.
>
> \-- Donald Knuth

## 坚持并传播正确原则

最近几周我好像总是在说服同事，**不要过早优化**。说的次数太多，我都有点烦了。
同事有多年的工程经验，照理说应该被过早优化坑过很多次。
但是人总是有局限性，我们尊重他人意见，只是必须**坚持并传播正确的原则**。


## 几个反面案例

### 案例1:不要仅为了减少RPC次数而合并不相关的接口

#### 需求简化如下

1. 在帖子详情页--显示「互动数」和「前三个互动的用户头像列表」
2. 在互动详情页(在帖子详情页点击后进入)--显示「互动数」和「所有互动用户的头像列表」

#### 同事的方案

##### RPC 接口

1. detail 接口，提供互动数量和所有互动用户的信息(分页)

##### 调用逻辑

用户在帖子详情页时，调用一次 detail 接口；
用户点击互动详情页时，不调用接口，直接用上一次获取的数据，知道用户滑动到分页结尾再去调用 detail 接口。

##### 背后思考

假设帖子详情页和互动详情页所需的信息会一直相同；
用户进入互动详情页后不需要额外调用接口，又快又节省服务器资源。

##### 质疑

我提出了四个质疑

1. 用户打开帖子详情页会慢
2. 由于用户不一定打开互动详情页，提前加载额外数据(多余的用户信息)会浪费服务器资源
3. 用户进入互动详情页后，看到的数据有延迟，且无法保证(跟用户在帖子详情页的停留时间有关)
4. 帖子详情页的需求跟互动详情页的需求不可能永远一致，一旦存在不一致，还是要拆开

针对这三个问题，同事的回复如下：

1. 服务端做优化，加缓存
2. 根据参数判断只加载3个用户，还是加载更多用户
3. 客户端根据在详情页停留时间判断是否要重新加载数据
4. 绑架产品决策，不让不一致（如果真能说服产品的话，也不是不行；但是我持强烈质疑态度）

可以看到，为了少调用一次 RPC 接口而强行合并接口，只能部分解决想象中的性能问题，但是会带来很多额外的问题。

#### 我的方案

##### RPC 接口

1. stat 接口，提供互动数量和前三个互动用户的信息
2. detail 接口，提供互动数量和所有互动用户的信息(分页)

##### 调用逻辑

用户在帖子详情页时，只调用 stat 接口；
用户点击互动详情页时，调用 detail 接口。

##### 背后思考

我没有把互动数拆成单独接口，因为从页面展示的一致性考虑，「互动数」和「头像列表长度」强相关，适合在一个接口内返回，这样能由服务端保证数据的一致性。

在我思考的过程中，没有考虑性能优化，只是从功能的正确性出发，很自然地得出了两个跟功能几乎完全对应的接口。

但是这个方案，性能上有问题吗？

首先从页面加载时间看，用户进入帖子详情页时，由于不需要拉全部的互动用户信息，所以会很快返回；
当用户点击互动详情页后，再去拉取互动用户的详细信息，这里需要根据实际的数据量和并发用户数考虑，在并发用户数少的时候不会有性能问题。

如果真的遇到了性能问题，也可以根据实际的瓶颈点，在客户端和服务端分别做优化：
1. 客户端在加载完帖子详情页后，提前加调用 detail 接口获取数据（不是很推荐，因为数据会有延迟）
2. 服务端通过~~加钱~~加多级缓存、加机器、加存储实例来水平扩容

总之，这个方案完全按照需求的原始形态不会在没有明确数据的情况下，为了想象中的性能收益去扭曲实现逻辑。

### 案例2:不要为了假象的性能瓶颈做特化方案

#### 需求简化如下

1. 用户搜索某物品后，将搜索结果存入数据库
> 搜索接口不是同部门提供，需要在本部门冗余存储（虽然也有点过度设计，但是我被说服了，毕竟其他部门的接口功能不全）

#### 同事的方案

##### RPC 接口

1. search 接口，提供其他部门搜索接口的代理(同时加一些逻辑)
2. save 接口，用于持久化物品信息到数据库

##### 调用逻辑

用户搜索时，调用 search 接口，search 接口内部把物品信息存储到缓存；
用户选中结果后，调用 save 接口但是只传 id，接口内部根据 id 把 缓存的内容存储到数据库。

##### 背后思考

假设数据库很慢，来不及把用搜索结果写入数据库后再返回给用户，但是缓存很快，可以先把搜索结果写到缓存；
假设用户搜索的结果会很多，为了节省空间，只把用户选中的物品信息存储到数据库；
为啥不让客户端在调用 save 接口时把物品信息带过来呢？因为不要相信客户端，这是一条安全方面的原则。

##### 质疑

我提出了三个质疑

1. 用户选中结果后会进入物品详情页，持久化完成之前，必须通过缓存获取信息，这会污染所有要拿物品信息的接口
2. 存储到数据库可能失败，如果要保证存储的最终完成，需要使用巡检或重试队列
3. 客户端增加了不必要的复杂度（本来可以在服务端解决，客户端不需要感知这件事）

针对这三个问题，同事也没有什么好办法。

#### 我的方案

##### RPC 接口

1. search 接口，提供其他部门搜索接口的代理

##### 调用逻辑

用户搜索时，调用 search 接口，search 接口内部把物品信息持久化到数据库，持久化完成后再向用户返回结果。

##### 背后思考

数据库没有想象中的那么慢，同时写入的 qps 也远远没到数据库的瓶颈，直接写入就行。

在这里，我没有考虑性能优化，只是从数据的持久性和不暴露服务端内部细节的角度出发，得到了一个看起来很粗暴的方案。

但是在负载不高的情况下，这个方案在性能上没有问题，而且负载看起来也从没高过(🐶)


todo 某公司上微信九宫格，预估注册qps过万
